<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8" />
        <!-- Î∑∞Ìè¨Ìä∏ ÏÑ§Ï†ï -->
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>TurtleBot3 Dashboard | Phoenix Control</title>
        <style>
            body {
                opacity: 0;
                transition: all 0.3s ease-in-out;
            }
        </style>
        <link
            as="style"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
            onload="this.onload=null;this.rel='stylesheet'"
            rel="stylesheet"
        />
        <link
            as="style"
            href="{{ url_for('static', path='/lib/SwiperJs/swiper-bundle.min.css') }}"
            onload="this.onload=null;this.rel='stylesheet'"
            rel="stylesheet"
        />
        <link
            href="{{ url_for('static', path='/css/wpo-minify-header-contact-form-71759816380.min.css') }}"
            id="wpo_min-header-0-css"
            media="all"
            rel="stylesheet"
            type="text/css"
        />
        <link
            as="style"
            href="{{ url_for('static', path='/css/style.css') }}?v=7"
            onload="this.onload=null;this.rel='stylesheet'"
            rel="stylesheet"
        />
        <link
            href="{{ url_for('static', path='/css/local-fonts.css') }}"
            rel="stylesheet"
        />
        <link
            rel="stylesheet"
            href="{{ url_for('static', path='/css/dashboard.css') }}?v=13"
        />
        <noscript>
            <link
                href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
                rel="stylesheet"
            />
            <link
                href="{{ url_for('static', path='/lib/SwiperJs/swiper-bundle.min.css') }}"
                rel="stylesheet"
            />
            <link
                href="{{ url_for('static', path='/css/style.css') }}?v=4"
                rel="stylesheet"
            />
        </noscript>
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                "use strict";
                var body = document.querySelector("body");
                body.style.opacity = 1;
            });
        </script>
    </head>
    <body class="dashboard-page" style="opacity: 1">
        <!-- Ìó§Îçî ÏòÅÏó≠ -->

        <header>
            <div class="container">
                <div class="brand">
                    <a
                        class="hoverable-sm brand-logo logo-white"
                        href="{{ request.base_url }}"
                    >
                        <canvas
                            height="96"
                            style="
                                width: 100%;
                                height: 100%;
                                transform-origin: 0px 0px 0px;
                                content-visibility: visible;
                            "
                            width="96"
                        ></canvas>
                    </a>
                </div>
                <div class="navigation">
                    <div class="navigation-header">
                        <div class="navigation-brand">
                            <a
                                class="anchor brand-logo logo-white"
                                href="{{ request.base_url }}"
                            >
                                <canvas
                                    height="0"
                                    style="
                                        width: 100%;
                                        height: 100%;
                                        transform-origin: 0px 0px 0px;
                                        content-visibility: visible;
                                    "
                                    width="0"
                                ></canvas>
                            </a>
                        </div>
                        <button class="btn-menu-trigger" type="button">
                            <i class="fa-regular fa-fw fa-x"></i>
                        </button>
                    </div>
                    <ul class="navigation-menu">
                        <li>
                            <a
                                class="menu-item anchor hoverable-sm"
                                href="{{ request.base_url }}"
                            >
                                <span
                                >
                                    Ïä§ÌäúÎîîÏò§
                                </span>
                            </a>
                        </li>
                        <li>
                            <a
                                class="menu-item anchor hoverable-sm active"
                                href="{{ url_for('read_dashboard') }}"
                            >
                                <span
                                >
                                    ÎåÄÏãúÎ≥¥Îìú
                                </span>
                            </a>
                        </li>
                        <li>
                            <a
                                class="menu-item anchor hoverable-sm"
                                href="{{ url_for('read_works') }}"
                            >
                                <span
                                >
                                    ÏûëÏóÖÎ¨º
                                </span>
                            </a>
                        </li>
                        <li>
                            <a
                                class="menu-item anchor hoverable-sm"
                                href="{{ url_for('read_contact') }}"
                            >
                                <span
                                >
                                    Î¨∏ÏùòÌïòÍ∏∞
                                </span>
                            </a>
                        </li>
                    </ul>
                </div>
                <button class="btn-menu-trigger" type="button">
                    <i class="fa-regular fa-fw fa-bars"></i>
                </button>
            </div>
        </header>

        <!-- Î©îÏù∏ ÏΩòÌÖêÏ∏† ÏòÅÏó≠ -->

        <main class="dashboard-main">
            <!-- ÏóêÎÑàÏßÄ ÌùêÎ¶Ñ ÏÑπÏÖò (ÏôºÏ™Ω) -->

            <section class="card energy-flow">
                <div class="card-header">
                    <h2>SLAM MAP</h2>
                </div>
                <div class="energy-content">
                    <div class="slam-map-container">
                        <img
                            id="slamMap"
                            class="slam-map-img"
                            src="/slam/map"
                            alt="SLAM Map"
                            onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                        />
                        <div class="map-waiting" style="display: none">
                            <div class="waiting-spinner"></div>
                            <p>SLAM Îßµ ÎåÄÍ∏∞ Ï§ë...</p>
                        </div>
                    </div>
                </div>
                <!-- ÌïòÎã® ÏÉÅÌÉú Î∞î: ÎÇ†Ïßú, Ïò®ÎèÑ, Î∞∞ÌÑ∞Î¶¨ -->
                <div class="status-bar">
                    <!-- 1) ÎÇ†Ïßú Ï†ïÎ≥¥ -->
                    <div class="status-item date-card">
                        <span class="date-value" id="currentDate">2025/12/06</span>
                    </div>
                    
                    <!-- 2) ÎÇ†Ïî® Ï†ïÎ≥¥ (Í∏∞ÏÉÅÏ≤≠ API + IP ÏúÑÏπò) -->
                    <div class="status-item temp-card">
                        <span class="weather-label" id="weatherLocation">--</span>
                        <div class="weather-temp">
                            <i id="weatherIcon" class="fas fa-sun"></i>
                            <span id="weatherTemp">--¬∞C</span>
                        </div>
                        <div class="weather-sky">
                            <span id="weatherSky">--</span>
                        </div>
                        <div class="weather-wind">
                            <i class="fas fa-wind"></i>
                            <span id="weatherWind">--</span>
                            <span class="wind-unit">m/s</span>
                        </div>
                    </div>
                    
                    <!-- 3) Î∞∞ÌÑ∞Î¶¨ Ï†ïÎ≥¥ -->
                    <div class="status-item battery-card">
                        <span class="battery-label">BATTERY</span>
                        <div class="battery-time">
                            <span class="time-value" id="batteryVoltage">--</span>
                            <span class="time-unit">V</span>
                        </div>
                        <div class="battery-detail">
                            <div class="battery-icon">
                                <div class="battery-fill" id="batteryFill" style="width: 0%;"></div>
                            </div>
                            <span class="battery-percent" id="batteryPercent">--%</span>
                        </div>
                    </div>
                </div>
                
                <!-- Î°úÎ¥á ÏãúÏä§ÌÖú Ï†ïÎ≥¥ Î∞î -->
                <div class="status-bar system-bar">
                    <!-- 4) CPU Ïò®ÎèÑ -->
                    <div class="status-item system-card">
                        <span class="system-label">CPU TEMP</span>
                        <div class="system-value">
                            <i class="fas fa-microchip"></i>
                            <span id="cpuTemp">--¬∞C</span>
                        </div>
                    </div>
                    
                    <!-- 5) CPU ÏÇ¨Ïö©Î•† -->
                    <div class="status-item system-card">
                        <span class="system-label">CPU USAGE</span>
                        <div class="system-value">
                            <i class="fas fa-chart-line"></i>
                            <span id="cpuUsage">--%</span>
                        </div>
                    </div>
                    
                    <!-- 6) WiFi Ïã†Ìò∏ Í∞ïÎèÑ -->
                    <div class="status-item system-card wifi-card">
                        <span class="system-label">WIFI</span>
                        <div class="system-value">
                            <i class="fas fa-wifi"></i>
                            <span id="wifiSignal">-- dBm</span>
                            <span id="wifiStatus" class="wifi-status">--</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Î°úÎ¥á Ïπ¥Îìú ÏÑπÏÖò (Ïò§Î•∏Ï™Ω ÏÉÅÎã®) -->

            <section class="card robot-card">
                <div class="robot-header-compact">
                    <span class="robot-title-sm">TURTLEBOT-3</span>
                </div>
                <div class="camera-view">
                    <img
                        id="cameraStream"
                        src="/camera/stream"
                        alt="TurtleBot3 Camera"
                    />
                </div>
                
                <!-- WASD Ïª®Ìä∏Î°§ + STOP Î≤ÑÌäº -->
                <div class="teleop-controls">
                    <!-- WASD Î∞©Ìñ•ÌÇ§ -->
                    <div class="wasd-pad">
                        <div class="wasd-row">
                            <button class="wasd-btn" id="btn-w" data-key="w">W</button>
                        </div>
                        <div class="wasd-row middle">
                            <button class="wasd-btn" id="btn-a" data-key="a">A</button>
                            <button class="wasd-btn center" id="btn-s" data-key="s">S</button>
                            <button class="wasd-btn" id="btn-d" data-key="d">D</button>
                        </div>
                        <div class="wasd-row">
                            <button class="wasd-btn" id="btn-x" data-key="x">X</button>
                        </div>
                    </div>
                    
                    <!-- Í∏¥Í∏â Ï†ïÏßÄ Î≤ÑÌäº -->
                    <button class="stop-btn" id="btn-stop" onclick="emergencyStop()">
                        STOP
                    </button>
                </div>
                
                <!-- CCTV ÌôîÎ©¥ (Î°úÎ¥á Ïπ¥Îìú ÏïÑÎûò) -->
                <div class="cctv-section">
                    <div class="cctv-label">
                        <span>Î¨∏ÏÇ¥ÏÇ¥ CCTV</span>
                        <span class="db-display" id="cctvDb">-- dB</span>
                        <button class="cctv-power-btn" id="cctvPowerBtn" onclick="toggleCctvPower()">
                            <i class="fas fa-power-off"></i>
                        </button>
                    </div>
                    <div class="cctv-view-inline">
                        <img 
                            id="cctvStream" 
                            src="/cctv/stream" 
                            alt="CCTV Stream"
                            onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                        />
                        <div class="cctv-waiting" style="display: none">
                            <p>CCTV Ïó∞Í≤∞ ÎåÄÍ∏∞ Ï§ë...</p>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- ********|| ÏûêÎ∞îÏä§ÌÅ¨Î¶ΩÌä∏ ÏãúÏûë ||******** -->
        <script
            defer="defer"
            src="{{ url_for('static', path='/lib/Lottie/lottie.min.js') }}"
            type="text/javascript"
        ></script>
        <script
            defer="defer"
            src="{{ url_for('static', path='/lib/GSAP_v3.12.4/gsap.min.js') }}"
            type="text/javascript"
        ></script>
        <script
            defer="defer"
            src="{{ url_for('static', path='/lib/GSAP_v3.12.4/ScrollTrigger.min.js') }}"
            type="text/javascript"
        ></script>
        <script
            defer="defer"
            src="{{ url_for('static', path='/lib/GSAP_v3.12.4/ScrollToPlugin.min.js') }}"
            type="text/javascript"
        ></script>
        <script
            defer="defer"
            src="{{ url_for('static', path='/lib/SwiperJs/swiper-bundle.min.js') }}"
            type="text/javascript"
        ></script>
        <script
            src="{{ url_for('static', path='/lib/SmoothScroll/SmoothScroll.min.js') }}"
            type="text/javascript"
        ></script>
        <script
            src="{{ url_for('static', path='/js/script.js') }}?v=2"
            type="text/javascript"
        ></script>
        <script src="{{ url_for('static', path='/js/dashboard.js') }}"></script>
        <script>
            function togglePower(btn) {
                btn.classList.toggle("active");
                const statusEl = btn.nextElementSibling;
                if (btn.classList.contains("active")) {
                    statusEl.innerHTML =
                        'ON <span class="status-off">OFF</span>';
                } else {
                    statusEl.innerHTML =
                        '<span class="status-off">ON</span> OFF';
                }
            }
            
            // ÌòÑÏû¨ ÎÇ†Ïßú ÌëúÏãú
            function updateDate() {
                const now = new Date();
                const y = now.getFullYear();
                const m = String(now.getMonth() + 1).padStart(2, '0');
                const d = String(now.getDate()).padStart(2, '0');
                document.getElementById('currentDate').textContent = `${y}/${m}/${d}`;
            }
            updateDate();
            
            // ÎÇ†Ïî® Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏ (Í∏∞ÏÉÅÏ≤≠ API + IP Í∏∞Î∞ò ÏúÑÏπò)
            async function updateWeather() {
                try {
                    const response = await fetch('/api/weather');
                    const data = await response.json();
                    
                    // ÏúÑÏπò ÌëúÏãú
                    document.getElementById('weatherLocation').textContent = data.location || '--';
                    
                    // Ïò®ÎèÑ ÌëúÏãú
                    document.getElementById('weatherTemp').textContent = 
                        data.temperature !== undefined ? `${data.temperature}¬∞C` : '--¬∞C';
                    
                    // ÎÇ†Ïî® ÏïÑÏù¥ÏΩò ÏóÖÎç∞Ïù¥Ìä∏
                    const iconEl = document.getElementById('weatherIcon');
                    if (data.icon) {
                        iconEl.className = 'fas ' + data.icon;
                    }
                    
                    // ÌïòÎäò ÏÉÅÌÉú ÌëúÏãú
                    document.getElementById('weatherSky').textContent = data.sky || '--';
                    
                    // ÌíçÏÜç ÌëúÏãú
                    document.getElementById('weatherWind').textContent = 
                        data.wind_speed !== undefined ? data.wind_speed.toFixed(1) : '--';
                        
                } catch (error) {
                    console.error('Weather update error:', error);
                }
            }
            
            // Ï¥àÍ∏∞ Î°úÎìú Î∞è 10Î∂ÑÎßàÎã§ ÎÇ†Ïî® ÏóÖÎç∞Ïù¥Ìä∏
            updateWeather();
            setInterval(updateWeather, 10 * 60 * 1000);
            
            // Î°úÎ¥á ÏãúÏä§ÌÖú Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
            async function updateSystemInfo() {
                try {
                    const response = await fetch('/api/system');
                    const data = await response.json();
                    
                    document.getElementById('cpuTemp').textContent = 
                        data.cpu_temperature !== undefined ? `${data.cpu_temperature}¬∞C` : '--¬∞C';
                    document.getElementById('cpuUsage').textContent = 
                        data.cpu_usage !== undefined ? `${data.cpu_usage}%` : '--%';
                    
                    // WiFi Ïã†Ìò∏ Í∞ïÎèÑ Î∞è ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                    if (data.wifi_signal !== undefined) {
                        const signal = data.wifi_signal;
                        document.getElementById('wifiSignal').textContent = `${signal} dBm`;
                        
                        // Ïã†Ìò∏ Í∞ïÎèÑÏóê Îî∞Î•∏ ÏÉÅÌÉú ÌëúÏãú
                        let status = '';
                        let statusClass = '';
                        if (signal >= -50) {
                            status = 'Îß§Ïö∞ Ï¢ãÏùå';
                            statusClass = 'wifi-excellent';
                        } else if (signal >= -60) {
                            status = 'Ï¢ãÏùå';
                            statusClass = 'wifi-good';
                        } else if (signal >= -70) {
                            status = 'Î≥¥ÌÜµ';
                            statusClass = 'wifi-fair';
                        } else if (signal >= -80) {
                            status = 'ÏïΩÌï®';
                            statusClass = 'wifi-weak';
                        } else {
                            status = 'Îß§Ïö∞ ÏïΩÌï®';
                            statusClass = 'wifi-poor';
                        }
                        
                        const wifiStatusEl = document.getElementById('wifiStatus');
                        wifiStatusEl.textContent = status;
                        wifiStatusEl.className = 'wifi-status ' + statusClass;
                    } else {
                        document.getElementById('wifiSignal').textContent = '-- dBm';
                        document.getElementById('wifiStatus').textContent = '--';
                    }
                    
                    // Î∞∞ÌÑ∞Î¶¨ Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
                    if (data.battery_percentage !== undefined) {
                        const batteryPct = Math.round(data.battery_percentage);
                        document.getElementById('batteryPercent').textContent = `${batteryPct}%`;
                        document.getElementById('batteryFill').style.width = `${batteryPct}%`;
                    }
                    if (data.battery_voltage !== undefined) {
                        document.getElementById('batteryVoltage').textContent = data.battery_voltage.toFixed(1);
                    }
                } catch (error) {
                    console.error('System info update error:', error);
                }
            }
            
            // Ï¥àÍ∏∞ Î°úÎìú Î∞è 2Ï¥àÎßàÎã§ ÏãúÏä§ÌÖú Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
            updateSystemInfo();
            setInterval(updateSystemInfo, 2000);
            
            // Î°úÎ¥á Ï†úÏñ¥ Î™ÖÎ†π Ï†ÑÏÜ°
            function sendCommand(cmd) {
                console.log("COMMAND:", cmd);
                // ÌÇ§ Îß§Ìïë: forward->w, backward->x, left->a, right->d, stop->s
                const keyMapping = {
                    'forward': 'w',
                    'backward': 'x',
                    'left': 'a',
                    'right': 'd',
                    'stop': 's'
                };
                const key = keyMapping[cmd] || cmd;
                
                fetch('/api/teleop', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ key: key })
                })
                .then(response => response.json())
                .then(data => console.log('Teleop response:', data))
                .catch(error => console.error('Teleop error:', error));
            }
            
            // Í∏¥Í∏â Ï†ïÏßÄ Ìï®Ïàò (Ïò§ÏûëÎèô Ïãú Í∞ïÏ†ú Ï†ïÏßÄ)
            let emergencyStopInterval = null;
            function emergencyStop() {
                const stopBtn = document.getElementById('btn-stop');
                
                // Ïù¥ÎØ∏ Í∏¥Í∏â Ï†ïÏßÄ Ï§ëÏù¥Î©¥ Î¨¥Ïãú
                if (emergencyStopInterval) return;
                
                console.log("üö® EMERGENCY STOP ACTIVATED");
                
                // Î≤ÑÌäº ÏãúÍ∞ÅÏ†Å ÌîºÎìúÎ∞±
                stopBtn.classList.add('emergency-active');
                stopBtn.textContent = 'STOPPING...';
                
                // 1Ï¥àÍ∞Ñ 100ms Í∞ÑÍ≤©ÏúºÎ°ú Ï†ïÏßÄ Î™ÖÎ†π Ï†ÑÏÜ° (10Ìöå)
                let count = 0;
                emergencyStopInterval = setInterval(() => {
                    sendCommand('stop');
                    count++;
                    
                    if (count >= 10) {
                        clearInterval(emergencyStopInterval);
                        emergencyStopInterval = null;
                        
                        // Î≤ÑÌäº Î≥µÏõê
                        stopBtn.classList.remove('emergency-active');
                        stopBtn.textContent = 'STOP';
                        console.log("‚úÖ Emergency stop complete");
                    }
                }, 100);
            }
            
            // WASD ÌÇ§ Îß§Ìïë
            const keyMap = {
                'w': { cmd: 'forward', btn: 'btn-w' },
                'a': { cmd: 'left', btn: 'btn-a' },
                's': { cmd: 'stop', btn: 'btn-s' },
                'd': { cmd: 'right', btn: 'btn-d' },
                'x': { cmd: 'backward', btn: 'btn-x' }
            };
            
            // ÌÇ§Î≥¥Îìú Ïù¥Î≤§Ìä∏ Ìï∏Îì§Îü¨
            document.addEventListener('keydown', function(e) {
                const key = e.key.toLowerCase();
                if (keyMap[key]) {
                    e.preventDefault();
                    const btnEl = document.getElementById(keyMap[key].btn);
                    if (btnEl && !btnEl.classList.contains('active')) {
                        btnEl.classList.add('active');
                        sendCommand(keyMap[key].cmd);
                    }
                }
            });
            
            document.addEventListener('keyup', function(e) {
                const key = e.key.toLowerCase();
                if (keyMap[key]) {
                    const btnEl = document.getElementById(keyMap[key].btn);
                    if (btnEl) {
                        btnEl.classList.remove('active');
                        // SÌÇ§(Ï†ïÏßÄ)Í∞Ä ÏïÑÎãå Í≤ΩÏö∞ÏóêÎßå Ï†ïÏßÄ Î™ÖÎ†π Ï†ÑÏÜ°
                        if (key !== 's') {
                            sendCommand('stop');
                        }
                    }
                }
            });
            
            // ÎßàÏö∞Ïä§ ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
            document.querySelectorAll('.wasd-btn').forEach(btn => {
                btn.addEventListener('mousedown', function() {
                    const key = this.dataset.key;
                    if (keyMap[key]) {
                        sendCommand(keyMap[key].cmd);
                    }
                });
                btn.addEventListener('mouseup', function() {
                    const key = this.dataset.key;
                    if (key !== 's') {
                        sendCommand('stop');
                    }
                });
            });
            
            // ========== CCTV Í¥ÄÎ†® Ìï®Ïàò ==========
            // CCTV ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
            async function updateCctvStatus() {
                try {
                    const response = await fetch('/api/cctv/status');
                    const data = await response.json();
                    
                    document.getElementById('cctvDb').textContent = `${data.db || 0} dB`;
                    
                    const powerBtn = document.getElementById('cctvPowerBtn');
                    if (data.is_running) {
                        powerBtn.classList.add('on');
                    } else {
                        powerBtn.classList.remove('on');
                    }
                } catch (error) {
                    console.error('CCTV status error:', error);
                }
            }
            
            // CCTV Ï†ÑÏõê ÌÜ†Í∏Ä
            async function toggleCctvPower() {
                try {
                    const response = await fetch('/api/cctv/toggle_power', { method: 'POST' });
                    const data = await response.json();
                    console.log('CCTV power toggled:', data);
                    updateCctvStatus();
                } catch (error) {
                    console.error('CCTV toggle error:', error);
                }
            }
            
            // CCTV ÏÉÅÌÉú 1Ï¥àÎßàÎã§ ÏóÖÎç∞Ïù¥Ìä∏
            updateCctvStatus();
            setInterval(updateCctvStatus, 1000);
        </script>
        <!-- ********|| ÏûêÎ∞îÏä§ÌÅ¨Î¶ΩÌä∏ ÎÅù ||******** -->
    </body>
</html>
