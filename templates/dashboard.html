<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8" />
        <!-- 뷰포트 설정 -->
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>TurtleBot3 Dashboard | Phoenix Control</title>
        <style>
            body {
                opacity: 0;
                transition: all 0.3s ease-in-out;
            }
        </style>
        <link
            as="style"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
            onload="this.onload=null;this.rel='stylesheet'"
            rel="stylesheet"
        />
        <link
            as="style"
            href="{{ url_for('static', path='/lib/SwiperJs/swiper-bundle.min.css') }}"
            onload="this.onload=null;this.rel='stylesheet'"
            rel="stylesheet"
        />
        <link
            href="{{ url_for('static', path='/css/wpo-minify-header-contact-form-71759816380.min.css') }}"
            id="wpo_min-header-0-css"
            media="all"
            rel="stylesheet"
            type="text/css"
        />
        <link
            as="style"
            href="{{ url_for('static', path='/css/style.css') }}?v=7"
            onload="this.onload=null;this.rel='stylesheet'"
            rel="stylesheet"
        />
        <link
            href="{{ url_for('static', path='/css/local-fonts.css') }}"
            rel="stylesheet"
        />
        <link
            rel="stylesheet"
            href="{{ url_for('static', path='/css/dashboard.css') }}?v=13"
        />
        <noscript>
            <link
                href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
                rel="stylesheet"
            />
            <link
                href="{{ url_for('static', path='/lib/SwiperJs/swiper-bundle.min.css') }}"
                rel="stylesheet"
            />
            <link
                href="{{ url_for('static', path='/css/style.css') }}?v=4"
                rel="stylesheet"
            />
        </noscript>
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                "use strict";
                var body = document.querySelector("body");
                body.style.opacity = 1;
            });
        </script>
    </head>
    <body class="dashboard-page" style="opacity: 1">
        <!-- 헤더 영역 -->

        <header>
            <div class="container">
                <div class="brand">
                    <a
                        class="hoverable-sm brand-logo logo-white"
                        href="{{ request.base_url }}"
                    >
                        <canvas
                            height="96"
                            style="
                                width: 100%;
                                height: 100%;
                                transform-origin: 0px 0px 0px;
                                content-visibility: visible;
                            "
                            width="96"
                        ></canvas>
                    </a>
                </div>
                <div class="navigation">
                    <div class="navigation-header">
                        <div class="navigation-brand">
                            <a
                                class="anchor brand-logo logo-white"
                                href="{{ request.base_url }}"
                            >
                                <canvas
                                    height="0"
                                    style="
                                        width: 100%;
                                        height: 100%;
                                        transform-origin: 0px 0px 0px;
                                        content-visibility: visible;
                                    "
                                    width="0"
                                ></canvas>
                            </a>
                        </div>
                        <button class="btn-menu-trigger" type="button">
                            <i class="fa-regular fa-fw fa-x"></i>
                        </button>
                    </div>
                    <ul class="navigation-menu">
                        <li>
                            <a
                                class="menu-item anchor hoverable-sm"
                                href="{{ request.base_url }}"
                            >
                                <span
                                >
                                    스튜디오
                                </span>
                            </a>
                        </li>
                        <li>
                            <a
                                class="menu-item anchor hoverable-sm active"
                                href="{{ url_for('read_dashboard') }}"
                            >
                                <span
                                >
                                    대시보드
                                </span>
                            </a>
                        </li>
                        <li>
                            <a
                                class="menu-item anchor hoverable-sm"
                                href="{{ url_for('read_works') }}"
                            >
                                <span
                                >
                                    작업물
                                </span>
                            </a>
                        </li>
                        <li>
                            <a
                                class="menu-item anchor hoverable-sm"
                                href="{{ url_for('read_contact') }}"
                            >
                                <span
                                >
                                    문의하기
                                </span>
                            </a>
                        </li>
                    </ul>
                </div>
                <button class="btn-menu-trigger" type="button">
                    <i class="fa-regular fa-fw fa-bars"></i>
                </button>
            </div>
        </header>

        <!-- 메인 콘텐츠 영역 -->

        <main class="dashboard-main">
            <!-- 에너지 흐름 섹션 (왼쪽) -->

            <section class="card energy-flow">
                <div class="card-header">
                    <h2>SLAM MAP</h2>
                </div>
                <div class="energy-content">
                    <div class="slam-map-container">
                        <img
                            id="slamMap"
                            class="slam-map-img"
                            src="/slam/map"
                            alt="SLAM Map"
                            onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                        />
                        <div class="map-waiting" style="display: none">
                            <div class="waiting-spinner"></div>
                            <p>SLAM 맵 대기 중...</p>
                        </div>
                    </div>
                </div>
                <!-- 하단 상태 바: 날짜, 온도, 배터리 -->
                <div class="status-bar">
                    <!-- 1) 날짜 정보 -->
                    <div class="status-item date-card">
                        <span class="date-value" id="currentDate">2025/12/06</span>
                    </div>
                    
                    <!-- 2) 온도 정보 -->
                    <div class="status-item temp-card">
                        <span class="temp-label">Temp</span>
                        <div class="temp-value">
                            <i class="fas fa-thermometer-half"></i>
                            <span>30°C</span>
                        </div>
                    </div>
                    
                    <!-- 3) 배터리 정보 -->
                    <div class="status-item battery-card">
                        <span class="battery-label">BATTERY LIFE</span>
                        <div class="battery-time">
                            <span class="time-value">12</span>
                            <span class="time-unit">HR</span>
                        </div>
                        <div class="battery-detail">
                            <div class="battery-icon">
                                <div class="battery-fill" style="width: {{ status.battery }};"></div>
                            </div>
                            <span class="battery-percent">{{ status.battery }}%</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 로봇 카드 섹션 (오른쪽 상단) -->

            <section class="card robot-card">
                <div class="robot-header">
                    <h2 class="robot-title">TURTLEBOT-3</h2>
                </div>
                <div class="camera-label">
                    TURTLEBOT3 CAMERA 320×240 @ 30FPS
                </div>
                <div class="camera-view">
                    <img
                        id="cameraStream"
                        src="/camera/stream"
                        alt="TurtleBot3 Camera"
                    />
                </div>
                <div class="power-control">
                    <span class="power-label">POWER</span>
                    <button
                        class="power-btn active"
                        onclick="togglePower(this)"
                    >
                        <i class="fas fa-power-off"></i>
                    </button>
                    <span class="power-status">
                        ON
                        <span class="status-off">OFF</span>
                    </span>
                </div>
                
                <!-- WASD 컨트롤 + STOP 버튼 -->
                <div class="teleop-controls">
                    <!-- WASD 방향키 -->
                    <div class="wasd-pad">
                        <div class="wasd-row">
                            <button class="wasd-btn" id="btn-w" data-key="w">W</button>
                        </div>
                        <div class="wasd-row middle">
                            <button class="wasd-btn" id="btn-a" data-key="a">A</button>
                            <button class="wasd-btn center" id="btn-s" data-key="s">S</button>
                            <button class="wasd-btn" id="btn-d" data-key="d">D</button>
                        </div>
                        <div class="wasd-row">
                            <button class="wasd-btn" id="btn-x" data-key="x">X</button>
                        </div>
                    </div>
                    
                    <!-- STOP 버튼 -->
                    <button class="stop-btn" id="btn-stop" onclick="sendCommand('stop')">
                        STOP
                    </button>
                </div>
            </section>
        </main>

        <!-- ********|| 자바스크립트 시작 ||******** -->
        <script
            defer="defer"
            src="{{ url_for('static', path='/lib/Lottie/lottie.min.js') }}"
            type="text/javascript"
        ></script>
        <script
            defer="defer"
            src="{{ url_for('static', path='/lib/GSAP_v3.12.4/gsap.min.js') }}"
            type="text/javascript"
        ></script>
        <script
            defer="defer"
            src="{{ url_for('static', path='/lib/GSAP_v3.12.4/ScrollTrigger.min.js') }}"
            type="text/javascript"
        ></script>
        <script
            defer="defer"
            src="{{ url_for('static', path='/lib/GSAP_v3.12.4/ScrollToPlugin.min.js') }}"
            type="text/javascript"
        ></script>
        <script
            defer="defer"
            src="{{ url_for('static', path='/lib/SwiperJs/swiper-bundle.min.js') }}"
            type="text/javascript"
        ></script>
        <script
            src="{{ url_for('static', path='/lib/SmoothScroll/SmoothScroll.min.js') }}"
            type="text/javascript"
        ></script>
        <script
            src="{{ url_for('static', path='/js/script.js') }}?v=2"
            type="text/javascript"
        ></script>
        <script src="{{ url_for('static', path='/js/dashboard.js') }}"></script>
        <script>
            function togglePower(btn) {
                btn.classList.toggle("active");
                const statusEl = btn.nextElementSibling;
                if (btn.classList.contains("active")) {
                    statusEl.innerHTML =
                        'ON <span class="status-off">OFF</span>';
                } else {
                    statusEl.innerHTML =
                        '<span class="status-off">ON</span> OFF';
                }
            }
            
            // 현재 날짜 표시
            function updateDate() {
                const now = new Date();
                const y = now.getFullYear();
                const m = String(now.getMonth() + 1).padStart(2, '0');
                const d = String(now.getDate()).padStart(2, '0');
                document.getElementById('currentDate').textContent = `${y}/${m}/${d}`;
            }
            updateDate();
            
            // 로봇 제어 명령 전송
            function sendCommand(cmd) {
                console.log("COMMAND:", cmd);
                // TODO: 실제 API 호출로 교체
                // fetch('/api/control', { method: 'POST', body: JSON.stringify({ command: cmd }) });
            }
            
            // WASD 키 매핑
            const keyMap = {
                'w': { cmd: 'forward', btn: 'btn-w' },
                'a': { cmd: 'left', btn: 'btn-a' },
                's': { cmd: 'stop', btn: 'btn-s' },
                'd': { cmd: 'right', btn: 'btn-d' },
                'x': { cmd: 'backward', btn: 'btn-x' }
            };
            
            // 키보드 이벤트 핸들러
            document.addEventListener('keydown', function(e) {
                const key = e.key.toLowerCase();
                if (keyMap[key]) {
                    e.preventDefault();
                    const btnEl = document.getElementById(keyMap[key].btn);
                    if (btnEl && !btnEl.classList.contains('active')) {
                        btnEl.classList.add('active');
                        sendCommand(keyMap[key].cmd);
                    }
                }
            });
            
            document.addEventListener('keyup', function(e) {
                const key = e.key.toLowerCase();
                if (keyMap[key]) {
                    const btnEl = document.getElementById(keyMap[key].btn);
                    if (btnEl) {
                        btnEl.classList.remove('active');
                        // S키(정지)가 아닌 경우에만 정지 명령 전송
                        if (key !== 's') {
                            sendCommand('stop');
                        }
                    }
                }
            });
            
            // 마우스 클릭 이벤트
            document.querySelectorAll('.wasd-btn').forEach(btn => {
                btn.addEventListener('mousedown', function() {
                    const key = this.dataset.key;
                    if (keyMap[key]) {
                        sendCommand(keyMap[key].cmd);
                    }
                });
                btn.addEventListener('mouseup', function() {
                    const key = this.dataset.key;
                    if (key !== 's') {
                        sendCommand('stop');
                    }
                });
            });
        </script>
        <!-- ********|| 자바스크립트 끝 ||******** -->
    </body>
</html>
