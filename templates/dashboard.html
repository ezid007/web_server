<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8" />
        <!-- ë·°í¬íŠ¸ ì„¤ì • -->
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>TurtleBot3 Dashboard | Phoenix Control</title>
        <style>
            body {
                opacity: 0;
                transition: all 0.3s ease-in-out;
            }
        </style>
        <link
            as="style"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
            onload="this.onload=null;this.rel='stylesheet'"
            rel="stylesheet"
        />
        <link
            as="style"
            href="{{ url_for('static', path='/lib/SwiperJs/swiper-bundle.min.css') }}"
            onload="this.onload=null;this.rel='stylesheet'"
            rel="stylesheet"
        />
        <link
            href="{{ url_for('static', path='/css/wpo-minify-header-contact-form-71759816380.min.css') }}"
            id="wpo_min-header-0-css"
            media="all"
            rel="stylesheet"
            type="text/css"
        />
        <link
            as="style"
            href="{{ url_for('static', path='/css/style.css') }}?v=7"
            onload="this.onload=null;this.rel='stylesheet'"
            rel="stylesheet"
        />
        <link
            href="{{ url_for('static', path='/css/local-fonts.css') }}"
            rel="stylesheet"
        />
        <link
            rel="stylesheet"
            href="{{ url_for('static', path='/css/dashboard.css') }}?v=20"
        />
        <noscript>
            <link
                href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
                rel="stylesheet"
            />
            <link
                href="{{ url_for('static', path='/lib/SwiperJs/swiper-bundle.min.css') }}"
                rel="stylesheet"
            />
            <link
                href="{{ url_for('static', path='/css/style.css') }}?v=4"
                rel="stylesheet"
            />
        </noscript>
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                "use strict";
                var body = document.querySelector("body");
                body.style.opacity = 1;
            });
        </script>
    </head>
    <body class="dashboard-page" style="opacity: 1">
        <!-- í—¤ë” ì˜ì—­ -->

        <header>
            <div class="container">
                <div class="brand">
                    <a
                        class="hoverable-sm brand-logo logo-white"
                        href="{{ request.base_url }}"
                    >
                        <canvas
                            height="96"
                            style="
                                width: 100%;
                                height: 100%;
                                transform-origin: 0px 0px 0px;
                                content-visibility: visible;
                            "
                            width="96"
                        ></canvas>
                    </a>
                </div>
                <div class="navigation">
                    <div class="navigation-header">
                        <div class="navigation-brand">
                            <a
                                class="anchor brand-logo logo-white"
                                href="{{ request.base_url }}"
                            >
                                <canvas
                                    height="0"
                                    style="
                                        width: 100%;
                                        height: 100%;
                                        transform-origin: 0px 0px 0px;
                                        content-visibility: visible;
                                    "
                                    width="0"
                                ></canvas>
                            </a>
                        </div>
                        <button class="btn-menu-trigger" type="button">
                            <i class="fa-regular fa-fw fa-x"></i>
                        </button>
                    </div>
                    <ul class="navigation-menu">
                        <li>
                            <a
                                class="menu-item anchor hoverable-sm"
                                href="{{ request.base_url }}"
                            >
                                <span>ìŠ¤íŠœë””ì˜¤</span>
                            </a>
                        </li>
                        <li>
                            <a
                                class="menu-item anchor hoverable-sm active"
                                href="{{ url_for('read_dashboard') }}"
                            >
                                <span>ëŒ€ì‹œë³´ë“œ</span>
                            </a>
                        </li>
                        <li>
                            <a
                                class="menu-item anchor hoverable-sm"
                                href="{{ url_for('read_works') }}"
                            >
                                <span>ì‘ì—…ë¬¼</span>
                            </a>
                        </li>
                        <li>
                            <a
                                class="menu-item anchor hoverable-sm"
                                href="{{ url_for('read_contact') }}"
                            >
                                <span>ë¬¸ì˜í•˜ê¸°</span>
                            </a>
                        </li>
                    </ul>
                </div>
                <button class="btn-menu-trigger" type="button">
                    <span class="hamburger-icon"></span>
                </button>
            </div>
        </header>

        <!-- ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ -->

        <main class="dashboard-main">
            <!-- ì—ë„ˆì§€ íë¦„ ì„¹ì…˜ (ì™¼ìª½) -->

            <section class="card energy-flow">
                <!-- NAV2 MAP í—¤ë” -->
                <div class="card-header">
                    <h2>NAV2 MAP</h2>
                    <div class="nav2-controls">
                        <span id="nav2-status" class="nav2-status disconnected">
                            ì—°ê²° ì¤‘...
                        </span>
                        <button
                            class="nav2-btn"
                            onclick="nav2MapViewer && nav2MapViewer.centerMap()"
                            title="ë§µ ì¤‘ì•™ ì •ë ¬"
                        >
                            <i class="fas fa-crosshairs"></i>
                        </button>
                    </div>
                </div>

                <!-- ìƒë‹¨ ìƒíƒœ ë°”: ë‚ ì§œ, ë‚ ì”¨, WiFi -->
                <div class="status-bar mb-3">
                    <!-- 1) ë‚ ì§œ ì •ë³´ -->
                    <div class="status-item date-card">
                        <span class="date-value" id="currentDate">
                            2025/12/06
                        </span>
                    </div>

                    <!-- 2) ë‚ ì”¨ ì •ë³´ (ê¸°ìƒì²­ API + IP ìœ„ì¹˜) -->
                    <div class="status-item temp-card">
                        <span class="weather-label" id="weatherLocation">
                            --
                        </span>
                        <div class="weather-temp">
                            <i id="weatherIcon" class="fas fa-sun"></i>
                            <span id="weatherTemp">--Â°C</span>
                        </div>
                        <div class="weather-sky">
                            <span id="weatherSky">--</span>
                        </div>
                        <div class="weather-wind">
                            <i class="fas fa-wind"></i>
                            <span id="weatherWind">--</span>
                            <span class="wind-unit">m/s</span>
                        </div>
                    </div>

                    <!-- 3) WiFi ì‹ í˜¸ ê°•ë„ -->
                    <div class="status-item system-card wifi-card">
                        <span class="system-label">WIFI</span>
                        <div class="system-value">
                            <i class="fas fa-wifi"></i>
                            <span id="wifiSignal">-- dBm</span>
                            <span id="wifiStatus" class="wifi-status">--</span>
                        </div>
                    </div>
                </div>

                <div class="surveillance-split-layout">
                    <!-- ì™¼ìª½: Nav2 ë§µ ì˜ì—­ -->
                    <div class="nav2-section">
                        <div class="nav2-map-container">
                            <canvas
                                id="nav2Canvas"
                                width="600"
                                height="400"
                            ></canvas>
                        </div>
                        <div class="nav2-hint">
                            <span>ğŸ–±ï¸ í´ë¦­: Goal ì„¤ì •</span>
                            <span>ğŸ”„ íœ : í™•ëŒ€/ì¶•ì†Œ</span>
                            <span>âŒ¨ï¸ Ctrl+ë“œë˜ê·¸: ì´ë™</span>
                        </div>
                    </div>

                    <!-- ì˜¤ë¥¸ìª½: ì»¨íŠ¸ë¡¤ íŒ¨ë„ -->
                    <div class="control-section">
                        <!-- YOLO ê°ì§€ í† ê¸€ -->
                        <div class="yolo-control-panel">
                            <span class="control-label">YOLO ê°ì§€</span>
                            <div class="toggle-switch" id="yoloToggle" onclick="toggleYolo()"></div>
                        </div>

                        <!-- í« ëª¨ë“œ íŒ¨ë„ -->
                        <div class="pet-mode-panel">
                            <div class="panel-header">
                                <span class="panel-title">
                                    <i class="fas fa-dog"></i> I'm pet
                                </span>
                                <span class="panel-status inactive" id="petModeStatus">OFF</span>
                            </div>
                            <button class="pet-mode-btn" id="petModeBtn" onclick="togglePetMode()">
                                <i class="fas fa-paw"></i>
                                <span>í« ëª¨ë“œ ì‹œì‘</span>
                            </button>
                        </div>

                        <!-- ê°ì‹œ ëª¨ë“œ ì»¨íŠ¸ë¡¤ íŒ¨ë„ -->
                        <div class="surveillance-panel">
                            <div class="panel-header">
                                <span class="panel-title">ğŸ›¡ï¸ SURVEILLANCE</span>
                                <span class="panel-status inactive" id="surveillanceStatus">OFF</span>
                            </div>

                            <!-- ê°ì‹œ ì‹œê°„ëŒ€ ì„¤ì • -->
                            <div class="control-item">
                                <span class="control-label">ê°ì‹œ ì‹œê°„</span>
                                <div class="time-input-group">
                                    <input type="time" class="time-input" id="startTime" value="23:00" />
                                    <span class="time-separator">~</span>
                                    <input type="time" class="time-input" id="endTime" value="07:00" />
                                </div>
                            </div>

                            <!-- ê°•ì œ í™œì„±í™” í† ê¸€ -->
                            <div class="control-item">
                                <span class="control-label">ê°•ì œ í™œì„±í™”</span>
                                <div class="toggle-switch" id="forceToggle" onclick="toggleForce()"></div>
                            </div>

                            <!-- ê°ì‹œ ëª¨ë“œ ì‹œì‘/ì¤‘ì§€ ë²„íŠ¼ -->
                            <button class="surveillance-btn" id="surveillanceBtn" onclick="toggleSurveillance()">
                                <i class="fas fa-shield-alt"></i>
                                <span>ê°ì‹œ ëª¨ë“œ ì‹œì‘</span>
                            </button>

                            <!-- ìˆœì°° ìƒíƒœ í‘œì‹œ -->
                            <div class="patrol-status" id="patrolStatus" style="display: none;">
                                <div class="status-row">
                                    <span class="status-label">ìˆœì°° ìƒíƒœ</span>
                                    <span class="status-value" id="patrolState">ëŒ€ê¸° ì¤‘</span>
                                </div>
                                <div class="status-row">
                                    <span class="status-label">í˜„ì¬ í¬ì¸íŠ¸</span>
                                    <span class="status-value" id="currentPoint">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- í•˜ë‹¨ ìƒíƒœ ë°”: CPU ì˜¨ë„, CPU ì‚¬ìš©ë¥ , ë°°í„°ë¦¬ -->
                <div class="status-bar bottom-bar">
                    <!-- 4) CPU ì˜¨ë„ -->
                    <div class="status-item system-card">
                        <span class="system-label">CPU TEMP</span>
                        <div class="system-value">
                            <i class="fas fa-microchip"></i>
                            <span id="cpuTemp">--Â°C</span>
                        </div>
                    </div>

                    <!-- 5) CPU ì‚¬ìš©ë¥  -->
                    <div class="status-item system-card">
                        <span class="system-label">CPU USAGE</span>
                        <div class="system-value">
                            <i class="fas fa-chart-line"></i>
                            <span id="cpuUsage">--%</span>
                        </div>
                    </div>

                    <!-- 6) ë°°í„°ë¦¬ ì •ë³´ -->
                    <div class="status-item battery-card">
                        <span class="battery-label">BATTERY</span>
                        <div class="battery-time">
                            <span class="time-value" id="batteryVoltage">--</span>
                            <span class="time-unit">V</span>
                        </div>
                        <div class="battery-detail">
                            <div class="battery-icon">
                                <div class="battery-fill" id="batteryFill" style="width: 0%"></div>
                            </div>
                            <span class="battery-percent" id="batteryPercent">--%</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ë¡œë´‡ ì¹´ë“œ ì„¹ì…˜ (ì˜¤ë¥¸ìª½ ìƒë‹¨) -->

            <section class="card robot-card">
                <div class="robot-header-compact">
                    <span class="robot-title-sm">TURTLEBOT-3</span>
                </div>
                <div class="camera-view">
                    <img
                        id="cameraStream"
                        src="/camera/stream"
                        alt="TurtleBot3 Camera"
                    />
                </div>

                <!-- WASD ì»¨íŠ¸ë¡¤ + STOP ë²„íŠ¼ -->
                <div class="teleop-controls">
                    <!-- WASD ë°©í–¥í‚¤ -->
                    <div class="wasd-pad">
                        <div class="wasd-row">
                            <button class="wasd-btn" id="btn-w" data-key="w">
                                W
                            </button>
                        </div>
                        <div class="wasd-row middle">
                            <button class="wasd-btn" id="btn-a" data-key="a">
                                A
                            </button>
                            <button
                                class="wasd-btn center"
                                id="btn-s"
                                data-key="s"
                            >
                                S
                            </button>
                            <button class="wasd-btn" id="btn-d" data-key="d">
                                D
                            </button>
                        </div>
                        <div class="wasd-row">
                            <button class="wasd-btn" id="btn-x" data-key="x">
                                X
                            </button>
                        </div>
                    </div>

                    <!-- ê¸´ê¸‰ ì •ì§€ ë²„íŠ¼ -->
                    <button
                        class="stop-btn"
                        id="btn-stop"
                        onclick="emergencyStop()"
                        ontouchend="emergencyStop(); event.preventDefault();"
                    >
                        STOP
                    </button>
                </div>

                <!-- CCTV í™”ë©´ (ë¡œë´‡ ì¹´ë“œ ì•„ë˜) -->
                <div class="cctv-section">
                    <div class="cctv-label">
                        <span>ë¬¸ì‚´ì‚´ CCTV</span>
                        <span class="db-display" id="cctvDb">-- dB</span>
                        <button
                            class="cctv-power-btn"
                            id="cctvPowerBtn"
                            onclick="toggleCctvPower()"
                        >
                            <i class="fas fa-power-off"></i>
                        </button>
                    </div>
                    <div class="cctv-view-inline">
                        <img
                            id="cctvStream"
                            src="/cctv/stream"
                            alt="CCTV Stream"
                            onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                        />
                        <div class="cctv-waiting" style="display: none">
                            <p>CCTV ì—°ê²° ëŒ€ê¸° ì¤‘...</p>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- ********|| ìë°”ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘ ||******** -->
        <script
            defer="defer"
            src="{{ url_for('static', path='/lib/Lottie/lottie.min.js') }}"
            type="text/javascript"
        ></script>
        <script
            defer="defer"
            src="{{ url_for('static', path='/lib/GSAP_v3.12.4/gsap.min.js') }}"
            type="text/javascript"
        ></script>
        <script
            defer="defer"
            src="{{ url_for('static', path='/lib/GSAP_v3.12.4/ScrollTrigger.min.js') }}"
            type="text/javascript"
        ></script>
        <script
            defer="defer"
            src="{{ url_for('static', path='/lib/GSAP_v3.12.4/ScrollToPlugin.min.js') }}"
            type="text/javascript"
        ></script>
        <script
            defer="defer"
            src="{{ url_for('static', path='/lib/SwiperJs/swiper-bundle.min.js') }}"
            type="text/javascript"
        ></script>
        <script
            src="{{ url_for('static', path='/lib/SmoothScroll/SmoothScroll.min.js') }}"
            type="text/javascript"
        ></script>
        <script
            src="{{ url_for('static', path='/js/script.js') }}?v=2"
            type="text/javascript"
        ></script>
        <!-- Nav2 ë§µ ë·°ì–´ -->
        <script src="{{ url_for('static', path='/lib/roslib.min.js') }}"></script>
        <script src="{{ url_for('static', path='/js/nav2-map.js') }}?v=1"></script>
        <script src="{{ url_for('static', path='/js/dashboard.js') }}"></script>
        <script>
            function togglePower(btn) {
                btn.classList.toggle("active");
                const statusEl = btn.nextElementSibling;
                if (btn.classList.contains("active")) {
                    statusEl.innerHTML =
                        'ON <span class="status-off">OFF</span>';
                } else {
                    statusEl.innerHTML =
                        '<span class="status-off">ON</span> OFF';
                }
            }

            // í˜„ì¬ ë‚ ì§œ í‘œì‹œ
            function updateDate() {
                const now = new Date();
                const y = now.getFullYear();
                const m = String(now.getMonth() + 1).padStart(2, "0");
                const d = String(now.getDate()).padStart(2, "0");
                document.getElementById(
                    "currentDate"
                ).textContent = `${y}/${m}/${d}`;
            }
            updateDate();

            // ë‚ ì”¨ ì •ë³´ ì—…ë°ì´íŠ¸ (ê¸°ìƒì²­ API + IP ê¸°ë°˜ ìœ„ì¹˜)
            async function updateWeather() {
                try {
                    const response = await fetch("/api/weather");
                    const data = await response.json();

                    // ìœ„ì¹˜ í‘œì‹œ
                    document.getElementById("weatherLocation").textContent =
                        data.location || "--";

                    // ì˜¨ë„ í‘œì‹œ
                    document.getElementById("weatherTemp").textContent =
                        data.temperature !== undefined
                            ? `${data.temperature}Â°C`
                            : "--Â°C";

                    // ë‚ ì”¨ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
                    const iconEl = document.getElementById("weatherIcon");
                    if (data.icon) {
                        iconEl.className = "fas " + data.icon;
                    }

                    // í•˜ëŠ˜ ìƒíƒœ í‘œì‹œ
                    document.getElementById("weatherSky").textContent =
                        data.sky || "--";

                    // í’ì† í‘œì‹œ
                    document.getElementById("weatherWind").textContent =
                        data.wind_speed !== undefined
                            ? data.wind_speed.toFixed(1)
                            : "--";
                } catch (error) {
                    console.error("Weather update error:", error);
                }
            }

            // ì´ˆê¸° ë¡œë“œ ë° 10ë¶„ë§ˆë‹¤ ë‚ ì”¨ ì—…ë°ì´íŠ¸
            updateWeather();
            setInterval(updateWeather, 10 * 60 * 1000);

            // ë¡œë´‡ ì‹œìŠ¤í…œ ì •ë³´ ì—…ë°ì´íŠ¸
            async function updateSystemInfo() {
                try {
                    const response = await fetch("/api/system");
                    const data = await response.json();

                    document.getElementById("cpuTemp").textContent =
                        data.cpu_temperature !== undefined
                            ? `${data.cpu_temperature}Â°C`
                            : "--Â°C";
                    document.getElementById("cpuUsage").textContent =
                        data.cpu_usage !== undefined
                            ? `${data.cpu_usage}%`
                            : "--%";

                    // WiFi ì‹ í˜¸ ê°•ë„ ë° ìƒíƒœ ì—…ë°ì´íŠ¸
                    if (data.wifi_signal !== undefined) {
                        const signal = data.wifi_signal;
                        document.getElementById(
                            "wifiSignal"
                        ).textContent = `${signal} dBm`;

                        // ì‹ í˜¸ ê°•ë„ì— ë”°ë¥¸ ìƒíƒœ í‘œì‹œ
                        let status = "";
                        let statusClass = "";
                        if (signal >= -50) {
                            status = "ë§¤ìš° ì¢‹ìŒ";
                            statusClass = "wifi-excellent";
                        } else if (signal >= -60) {
                            status = "ì¢‹ìŒ";
                            statusClass = "wifi-good";
                        } else if (signal >= -70) {
                            status = "ë³´í†µ";
                            statusClass = "wifi-fair";
                        } else if (signal >= -80) {
                            status = "ì•½í•¨";
                            statusClass = "wifi-weak";
                        } else {
                            status = "ë§¤ìš° ì•½í•¨";
                            statusClass = "wifi-poor";
                        }

                        const wifiStatusEl =
                            document.getElementById("wifiStatus");
                        wifiStatusEl.textContent = status;
                        wifiStatusEl.className = "wifi-status " + statusClass;
                    } else {
                        document.getElementById("wifiSignal").textContent =
                            "-- dBm";
                        document.getElementById("wifiStatus").textContent =
                            "--";
                    }

                    // ë°°í„°ë¦¬ ì •ë³´ ì—…ë°ì´íŠ¸
                    if (data.battery_percentage !== undefined) {
                        const batteryPct = Math.round(data.battery_percentage);
                        document.getElementById(
                            "batteryPercent"
                        ).textContent = `${batteryPct}%`;
                        document.getElementById(
                            "batteryFill"
                        ).style.width = `${batteryPct}%`;
                    }
                    if (data.battery_voltage !== undefined) {
                        document.getElementById("batteryVoltage").textContent =
                            data.battery_voltage.toFixed(1);
                    }
                } catch (error) {
                    console.error("System info update error:", error);
                }
            }

            // ì´ˆê¸° ë¡œë“œ ë° 2ì´ˆë§ˆë‹¤ ì‹œìŠ¤í…œ ì •ë³´ ì—…ë°ì´íŠ¸
            updateSystemInfo();
            setInterval(updateSystemInfo, 2000);

            // ë¡œë´‡ ì œì–´ ëª…ë ¹ ì „ì†¡
            function sendCommand(cmd) {
                console.log("COMMAND:", cmd);
                // í‚¤ ë§¤í•‘: forward->w, backward->x, left->a, right->d, stop->s
                const keyMapping = {
                    forward: "w",
                    backward: "x",
                    left: "a",
                    right: "d",
                    stop: "s",
                };
                const key = keyMapping[cmd] || cmd;

                fetch("/api/teleop", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ key: key }),
                })
                    .then((response) => response.json())
                    .then((data) => console.log("Teleop response:", data))
                    .catch((error) => console.error("Teleop error:", error));
            }

            // ê¸´ê¸‰ ì •ì§€ í•¨ìˆ˜ (ì˜¤ì‘ë™ ì‹œ ê°•ì œ ì •ì§€)
            let emergencyStopInterval = null;
            function emergencyStop() {
                const stopBtn = document.getElementById("btn-stop");

                // ì´ë¯¸ ê¸´ê¸‰ ì •ì§€ ì¤‘ì´ë©´ ë¬´ì‹œ
                if (emergencyStopInterval) return;

                console.log("ğŸš¨ EMERGENCY STOP ACTIVATED");

                // Nav2 ë„¤ë¹„ê²Œì´ì…˜ Goal ì·¨ì†Œ
                if (nav2MapViewer && nav2MapViewer.connected) {
                    nav2MapViewer.cancelGoal();
                }

                // ë²„íŠ¼ ì‹œê°ì  í”¼ë“œë°±
                stopBtn.classList.add("emergency-active");
                stopBtn.textContent = "STOPPING...";

                // 1ì´ˆê°„ 100ms ê°„ê²©ìœ¼ë¡œ ì •ì§€ ëª…ë ¹ ì „ì†¡ (10íšŒ)
                let count = 0;
                emergencyStopInterval = setInterval(() => {
                    sendCommand("stop");
                    count++;

                    if (count >= 10) {
                        clearInterval(emergencyStopInterval);
                        emergencyStopInterval = null;

                        // ë²„íŠ¼ ë³µì›
                        stopBtn.classList.remove("emergency-active");
                        stopBtn.textContent = "STOP";
                        console.log("âœ… Emergency stop complete");
                    }
                }, 100);
            }

            // WASD í‚¤ ë§¤í•‘
            const keyMap = {
                w: { cmd: "forward", btn: "btn-w" },
                a: { cmd: "left", btn: "btn-a" },
                s: { cmd: "stop", btn: "btn-s" },
                d: { cmd: "right", btn: "btn-d" },
                x: { cmd: "backward", btn: "btn-x" },
            };

            // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
            document.addEventListener("keydown", function (e) {
                const key = e.key.toLowerCase();
                if (keyMap[key]) {
                    e.preventDefault();
                    const btnEl = document.getElementById(keyMap[key].btn);
                    if (btnEl && !btnEl.classList.contains("active")) {
                        btnEl.classList.add("active");
                        sendCommand(keyMap[key].cmd);
                    }
                }
            });

            document.addEventListener("keyup", function (e) {
                const key = e.key.toLowerCase();
                if (keyMap[key]) {
                    const btnEl = document.getElementById(keyMap[key].btn);
                    if (btnEl) {
                        btnEl.classList.remove("active");
                        // Sí‚¤(ì •ì§€)ê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ì •ì§€ ëª…ë ¹ ì „ì†¡
                        if (key !== "s") {
                            sendCommand("stop");
                        }
                    }
                }
            });

            // ë§ˆìš°ìŠ¤ í´ë¦­ ì´ë²¤íŠ¸
            document.querySelectorAll(".wasd-btn").forEach((btn) => {
                btn.addEventListener("mousedown", function () {
                    const key = this.dataset.key;
                    if (keyMap[key]) {
                        sendCommand(keyMap[key].cmd);
                    }
                });
                btn.addEventListener("mouseup", function () {
                    const key = this.dataset.key;
                    if (key !== "s") {
                        sendCommand("stop");
                    }
                });

                // ëª¨ë°”ì¼ í„°ì¹˜ ì´ë²¤íŠ¸ ì¶”ê°€
                btn.addEventListener(
                    "touchstart",
                    function (e) {
                        e.preventDefault(); // ë”ë¸”íƒ­ ì¤Œ ë°©ì§€
                        const key = this.dataset.key;
                        this.classList.add("active");
                        if (keyMap[key]) {
                            sendCommand(keyMap[key].cmd);
                        }
                    },
                    { passive: false }
                );

                btn.addEventListener(
                    "touchend",
                    function (e) {
                        e.preventDefault();
                        const key = this.dataset.key;
                        this.classList.remove("active");
                        if (key !== "s") {
                            sendCommand("stop");
                        }
                    },
                    { passive: false }
                );
            });

            // ========== CCTV ê´€ë ¨ í•¨ìˆ˜ ==========
            // CCTV ìƒíƒœ ì—…ë°ì´íŠ¸
            async function updateCctvStatus() {
                try {
                    const response = await fetch("/api/cctv/status");
                    const data = await response.json();

                    document.getElementById("cctvDb").textContent = `${
                        data.db || 0
                    } dB`;

                    const powerBtn = document.getElementById("cctvPowerBtn");
                    if (data.is_running) {
                        powerBtn.classList.add("on");
                    } else {
                        powerBtn.classList.remove("on");
                    }
                } catch (error) {
                    console.error("CCTV status error:", error);
                }
            }

            // CCTV ì „ì› í† ê¸€
            async function toggleCctvPower() {
                try {
                    const response = await fetch("/api/cctv/toggle_power", {
                        method: "POST",
                    });
                    const data = await response.json();
                    console.log("CCTV power toggled:", data);
                    updateCctvStatus();
                } catch (error) {
                    console.error("CCTV toggle error:", error);
                }
            }

            // CCTV ìƒíƒœ 1ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸
            updateCctvStatus();
            setInterval(updateCctvStatus, 1000);

            // ========== Nav2 ë§µ ë·°ì–´ ì´ˆê¸°í™” ==========
            // rosbridge ì„œë²„ URL (PC IP:9090)
            const rosbridgeUrl = "ws://" + window.location.hostname + ":9090";
            initNav2MapViewer(rosbridgeUrl);

            // ========== ê°ì‹œ ëª¨ë“œ ê´€ë ¨ í•¨ìˆ˜ ==========
            let surveillanceRunning = false;
            let yoloEnabled = false;
            let forceEnabled = false;

            // YOLO í† ê¸€
            async function toggleYolo() {
                try {
                    const response = await fetch("/api/yolo/toggle", { method: "POST" });
                    const data = await response.json();
                    yoloEnabled = data.enabled;
                    updateYoloUI();
                    console.log("YOLO toggled:", data);
                } catch (error) {
                    console.error("YOLO toggle error:", error);
                }
            }

            function updateYoloUI() {
                const toggle = document.getElementById("yoloToggle");
                if (yoloEnabled) {
                    toggle.classList.add("on");
                } else {
                    toggle.classList.remove("on");
                }
            }

            // ========== í« ëª¨ë“œ ê´€ë ¨ í•¨ìˆ˜ ==========
            let petModeEnabled = false;

            async function togglePetMode() {
                try {
                    petModeEnabled = !petModeEnabled;
                    // TODO: ë°±ì—”ë“œ API ì—°ë™ (ì¶”í›„ êµ¬í˜„)
                    // const response = await fetch("/api/pet/toggle", { method: "POST" });
                    // const data = await response.json();
                    // petModeEnabled = data.enabled;
                    updatePetModeUI();
                    console.log("Pet mode toggled:", petModeEnabled);
                } catch (error) {
                    console.error("Pet mode toggle error:", error);
                }
            }

            function updatePetModeUI() {
                const btn = document.getElementById("petModeBtn");
                const status = document.getElementById("petModeStatus");
                
                if (petModeEnabled) {
                    btn.classList.add("active");
                    btn.querySelector("span").textContent = "í« ëª¨ë“œ ì¤‘ì§€";
                    status.textContent = "ON";
                    status.className = "panel-status active";
                } else {
                    btn.classList.remove("active");
                    btn.querySelector("span").textContent = "í« ëª¨ë“œ ì‹œì‘";
                    status.textContent = "OFF";
                    status.className = "panel-status inactive";
                }
            }

            // ê°•ì œ í™œì„±í™” í† ê¸€
            async function toggleForce() {
                try {
                    forceEnabled = !forceEnabled;
                    const response = await fetch(`/api/surveillance/force?enabled=${forceEnabled}`, {
                        method: "POST"
                    });
                    const data = await response.json();
                    forceEnabled = data.force_enabled;
                    updateForceUI();
                    console.log("Force toggled:", data);
                } catch (error) {
                    console.error("Force toggle error:", error);
                }
            }

            function updateForceUI() {
                const toggle = document.getElementById("forceToggle");
                if (forceEnabled) {
                    toggle.classList.add("on");
                } else {
                    toggle.classList.remove("on");
                }
            }

            // ê°ì‹œ ëª¨ë“œ ì‹œì‘/ì¤‘ì§€
            async function toggleSurveillance() {
                try {
                    const endpoint = surveillanceRunning ? "/api/surveillance/stop" : "/api/surveillance/start";
                    const response = await fetch(endpoint, { method: "POST" });
                    const data = await response.json();
                    console.log("Surveillance:", data);
                    
                    // ì‹œê°„ëŒ€ ì„¤ì • ì „ì†¡
                    if (!surveillanceRunning) {
                        await saveSchedule();
                    }
                    
                    await updateSurveillanceStatus();
                } catch (error) {
                    console.error("Surveillance toggle error:", error);
                }
            }

            // ì‹œê°„ëŒ€ ì €ì¥
            async function saveSchedule() {
                const startTime = document.getElementById("startTime").value;
                const endTime = document.getElementById("endTime").value;
                
                try {
                    const response = await fetch("/api/surveillance/schedule", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ start_time: startTime, end_time: endTime })
                    });
                    const data = await response.json();
                    console.log("Schedule saved:", data);
                } catch (error) {
                    console.error("Schedule save error:", error);
                }
            }

            // ìƒíƒœ ì—…ë°ì´íŠ¸
            async function updateSurveillanceStatus() {
                try {
                    const response = await fetch("/api/surveillance/status");
                    const data = await response.json();
                    
                    surveillanceRunning = data.is_running;
                    yoloEnabled = data.yolo_enabled;
                    forceEnabled = data.force_enabled;
                    
                    // UI ì—…ë°ì´íŠ¸
                    const statusEl = document.getElementById("surveillanceStatus");
                    const btn = document.getElementById("surveillanceBtn");
                    const patrolStatus = document.getElementById("patrolStatus");
                    
                    if (surveillanceRunning) {
                        statusEl.textContent = "ON";
                        statusEl.className = "panel-status active";
                        btn.classList.add("active");
                        btn.querySelector("span").textContent = "ê°ì‹œ ëª¨ë“œ ì¤‘ì§€";
                        patrolStatus.style.display = "flex";
                        
                        // ìˆœì°° ìƒíƒœ í‘œì‹œ
                        const patrolState = document.getElementById("patrolState");
                        const currentPoint = document.getElementById("currentPoint");
                        
                        if (data.is_responding_to_cctv) {
                            patrolState.textContent = "ğŸš¨ CCTV ê°ì§€ ëŒ€ì‘ ì¤‘";
                            patrolState.className = "status-value responding";
                        } else if (data.is_patrolling) {
                            patrolState.textContent = "ğŸš¶ ìˆœì°° ì¤‘";
                            patrolState.className = "status-value patrolling";
                        } else {
                            patrolState.textContent = "â³ ëŒ€ê¸° ì¤‘";
                            patrolState.className = "status-value";
                        }
                        
                        currentPoint.textContent = `í¬ì¸íŠ¸ ${data.current_patrol_index + 1}/3`;
                    } else {
                        statusEl.textContent = "OFF";
                        statusEl.className = "panel-status inactive";
                        btn.classList.remove("active");
                        btn.querySelector("span").textContent = "ê°ì‹œ ëª¨ë“œ ì‹œì‘";
                        patrolStatus.style.display = "none";
                    }
                    
                    updateYoloUI();
                    updateForceUI();
                    
                    // ì‹œê°„ëŒ€ ì…ë ¥ ì—…ë°ì´íŠ¸
                    if (data.schedule) {
                        document.getElementById("startTime").value = data.schedule.start_time;
                        document.getElementById("endTime").value = data.schedule.end_time;
                    }
                } catch (error) {
                    console.error("Surveillance status error:", error);
                }
            }

            // ì´ˆê¸° ìƒíƒœ ë¡œë“œ ë° ì£¼ê¸°ì  ì—…ë°ì´íŠ¸
            updateSurveillanceStatus();
            setInterval(updateSurveillanceStatus, 2000);
        </script>
        <!-- ********|| ìë°”ìŠ¤í¬ë¦½íŠ¸ ë ||******** -->
        
        <!-- ì±—ë´‡ ìœ„ì ¯ -->
        {% include 'components/chatbot_widget.html' %}
    </body>
</html>
